---
title: "Análisis de diferencia en vacunación"
author: "Brian Peña-Calero"
date: "14/7/2021"
output: 
  html_document: 
    toc: yes
    toc_float: yes
    number_sections: yes
    highlight: kate
    theme: flatly
    code_folding: hide
    toc_depth: 3
    code_download: TRUE
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
```

# Importación de datos

```{r}
vacunas <- readr::read_csv("1. Data/vacunas_covid.csv")
# adultos_mayores_2017 <- readRDS("1. Data/adultos_mayores_2017.rds")
poblacion_edades <- readxl::read_excel("1. Data/Poblacion Peru 2021 Dpto Prov Dist sexo.xlsx",
                                       sheet = "DEPARTAMENTAL",
                                       skip = 6)
```

[**Características:**]{.ul}

```{r}
vacunas %>% 
  glimpse()
```

## Formato de datos

```{r}
vacunas <- vacunas %>% 
  mutate(
    across(c(GRUPO_RIESGO, SEXO,
             DOSIS:DISTRITO),
           factor)
  ) 
```

# Análisis descriptivo de la data

```{r}
vacunas %>% 
  select(GRUPO_RIESGO:SEXO,
         DOSIS:FABRICANTE, 
         DEPARTAMENTO) %>% 
  summarytools::dfSummary() %>% 
  summarytools::view()
```

# Elaboración de los gráficos

```{r setup-plot, include=FALSE}
library(ggalt)
```

## Preparación de data

```{r}
adultos_mayores_dep <- poblacion_edades %>% 
  slice(2:26) %>% 
  select(UBIGEO:Total, ...50) %>% 
  rename(adultos_mayores = ...50) %>% 
  mutate(adultos_mayores = as.numeric(adultos_mayores))
```

### Gráfico de 2 dosis

```{r}
vacuna_dep_dosis_2 <- vacunas %>% 
  filter(DOSIS == 2, EDAD >= 60) %>% 
  count(DEPARTAMENTO,
        name = "Vacuna_dosis_2")

vacuna_dep_dosis_2 <- vacuna_dep_dosis_2 %>% 
  inner_join(adultos_mayores_dep) %>% 
  mutate(
    ratio_vacuna = Vacuna_dosis_2/Total,
    ratio_adulto_mayor = adultos_mayores/Total
  ) %>% 
  mutate(DEPARTAMENTO = str_to_title(DEPARTAMENTO))
```

```{r}
departamento_vac_2_adultos_mayores <- vacuna_dep_dosis_2 %>% 
  mutate(
    Diferencia = ratio_adulto_mayor - ratio_vacuna,
    DEPARTAMENTO = fct_reorder(DEPARTAMENTO, 
                               Diferencia)
  ) %>% 
  ggplot() +
  geom_segment(aes(y = DEPARTAMENTO, 
                   yend = DEPARTAMENTO,
                   x = 0, xend = 0.35), 
               color = "#b2b2b2", 
               size = 0.15) +
  geom_dumbbell(aes(y = DEPARTAMENTO,
                    x = ratio_vacuna,
                    xend = ratio_adulto_mayor),
                size = 1.5,
                color = "#b2b2b2", 
                colour_x = "#2c8ba7", 
                colour_xend = "#2f4871",
                size_x = 3,
                size_xend = 3) +
  geom_text(aes(x = 0.09,
                y = 25.7,
                label = "Vacunados"),
            color = "black",
            size = 3.1,
            fontface = "bold") +
  geom_text(aes(x = 0.18,
                y = 25.7,
                label = "+60 años"),
            color = "black",
            size = 3.1,
            fontface = "bold") +
  geom_text(aes(x = ratio_vacuna,
                y = DEPARTAMENTO,
                label = scales::percent(ratio_vacuna,
                                        accuracy = 1)),
            size = 3, vjust = 2.2) +
  geom_text(aes(x = ratio_adulto_mayor,
                y = DEPARTAMENTO,
                label = scales::percent(ratio_adulto_mayor,
                                        accuracy = 1)),
            size = 3, vjust = 2.2) +
  geom_rect(aes(xmin = 0.28,
                xmax = 0.32,
                ymin = -Inf,
                ymax = Inf),
            fill = "grey") +
  geom_text(aes(x = 0.3,
                y = DEPARTAMENTO,
                label = scales::percent(Diferencia,
                                        accuracy = 1)),
            fontface = "bold",
            size = 3) +
  geom_text(aes(x = 0.3,
                y = 25.7,
                label = "Diff"),
            color = "black",
            size = 3.1,
            fontface = "bold") +
  theme_bw() +
  scale_x_continuous(expand=c(0,0), limits=c(0, 0.35)) +
  scale_y_discrete(expand=c(0.05,0)) +
  labs(y = "",
       x = "") + 
  theme_bw(base_family="Lato") +
  theme(
    panel.grid.major=element_blank(),
    panel.grid.minor=element_blank(),
    panel.border=element_blank(),
    axis.ticks=element_blank(),
    axis.text.x=element_blank(),
    plot.title=element_text(size = 16, face="bold"),
    plot.title.position = "plot",
    plot.subtitle=element_text(face="italic", size=12, margin=margin(b=12)),
    plot.caption=element_text(size=8, margin=margin(t=12), color="#7a7d7e")
  )
  
  

ggsave(filename = "2. Plots/Mayor diferencia en adultos mayores vacunados 2 dosis por departamento.png",
         plot = departamento_vac_2_adultos_mayores,
         height = 9,
         width = 6,
         dpi = 300)
```

### Gráfico de 1 dosis

```{r}
vacuna_dep_dosis_1 <- vacunas %>% 
  filter(DOSIS == 1, EDAD >= 60) %>% 
  count(DEPARTAMENTO,
        name = "Vacuna_dosis_1")

vacuna_dep_dosis_1 <- vacuna_dep_dosis_1 %>% 
  inner_join(adultos_mayores_dep) %>% 
  mutate(
    ratio_vacuna = Vacuna_dosis_1/Total,
    ratio_adulto_mayor = adultos_mayores/Total
  ) %>% 
  mutate(DEPARTAMENTO = str_to_title(DEPARTAMENTO))
```

```{r}
departamento_vac_1_adultos_mayores <- vacuna_dep_dosis_1 %>% 
  mutate(
    Diferencia = ratio_adulto_mayor - ratio_vacuna,
    DEPARTAMENTO = fct_reorder(DEPARTAMENTO, 
                               Diferencia)
  ) %>% 
  ggplot() +
  geom_segment(aes(y = DEPARTAMENTO, 
                   yend = DEPARTAMENTO,
                   x = 0, xend = 0.35), 
               color = "#b2b2b2", 
               size = 0.15) +
  geom_dumbbell(aes(y = DEPARTAMENTO,
                    x = ratio_vacuna,
                    xend = ratio_adulto_mayor),
                size = 1.5,
                color = "#b2b2b2", 
                colour_x = "#2c8ba7", 
                colour_xend = "#2f4871",
                size_x = 3,
                size_xend = 3) +
  geom_text(aes(x = 0.09,
                y = 25.7,
                label = "Vacunados"),
            color = "black",
            size = 3.1,
            fontface = "bold") +
  geom_text(aes(x = 0.18,
                y = 25.7,
                label = "+60 años"),
            color = "black",
            size = 3.1,
            fontface = "bold") +
  geom_text(aes(x = ratio_vacuna,
                y = DEPARTAMENTO,
                label = scales::percent(ratio_vacuna,
                                        accuracy = 1)),
            size = 3, vjust = 2.2) +
  geom_text(aes(x = ratio_adulto_mayor,
                y = DEPARTAMENTO,
                label = scales::percent(ratio_adulto_mayor,
                                        accuracy = 1)),
            size = 3, vjust = 2.2) +
  geom_rect(aes(xmin = 0.28,
                xmax = 0.32,
                ymin = -Inf,
                ymax = Inf),
            fill = "grey") +
  geom_text(aes(x = 0.3,
                y = DEPARTAMENTO,
                label = scales::percent(Diferencia,
                                        accuracy = 1)),
            fontface = "bold",
            size = 3) +
  geom_text(aes(x = 0.3,
                y = 25.7,
                label = "Diff"),
            color = "black",
            size = 3.1,
            fontface = "bold") +
  theme_bw() +
  scale_x_continuous(expand=c(0,0), limits=c(0, 0.35)) +
  scale_y_discrete(expand=c(0.05,0)) +
  labs(y = "",
       x = "") + 
  theme_bw(base_family="Lato") +
  theme(
    panel.grid.major=element_blank(),
    panel.grid.minor=element_blank(),
    panel.border=element_blank(),
    axis.ticks=element_blank(),
    axis.text.x=element_blank(),
    plot.title=element_text(size = 16, face="bold"),
    plot.title.position = "plot",
    plot.subtitle=element_text(face="italic", size=12, margin=margin(b=12)),
    plot.caption=element_text(size=8, margin=margin(t=12), color="#7a7d7e")
  )
  
  
ggsave(filename = "2. Plots/Mayor diferencia en adultos mayores vacunados 1 dosis por departamento.png",
       plot = departamento_vac_1_adultos_mayores,
       height = 9,
       width = 6,
       dpi = 300)
```

### Gráfico con ambas dosis

Contrastar edad mínima por departamento
Se podría calcular la edad mínima reportada en la data con solo grupo de riesgo de adulto mayor

```{r}
vacuna_dep_dosis <- vacunas %>% 
  filter(EDAD >= 60) %>% 
  count(DEPARTAMENTO, DOSIS,
        name = "n_personas")

vacuna_dep_dosis <- vacuna_dep_dosis %>% 
  bind_rows(
    adultos_mayores_dep %>% 
      select(DEPARTAMENTO, n_personas = adultos_mayores) %>% 
      mutate(DOSIS = "Adulto Mayor")
  ) %>% 
  inner_join(
    adultos_mayores_dep %>% 
      select(DEPARTAMENTO, Total)
  ) %>% 
  arrange(DEPARTAMENTO, DOSIS) %>% 
  mutate(
    ratio_vacuna = n_personas/Total
  ) %>% 
  mutate(DEPARTAMENTO = str_to_title(DEPARTAMENTO))
```

```{r}
departamento_vac_adultos_mayores <-
  vacuna_dep_dosis %>% 
  group_by(DEPARTAMENTO) %>% 
  mutate(
    Diff_1_dos_adulto_mayor = last(ratio_vacuna) - first(ratio_vacuna),
    Diff_2_dos_adulto_mayor = last(ratio_vacuna) - nth(ratio_vacuna, 2),
    Diff_1_dos_2_dos = first(ratio_vacuna) - nth(ratio_vacuna, 2),
  ) %>% 
  ungroup() %>% 
  mutate(
    DEPARTAMENTO = fct_reorder(DEPARTAMENTO,
                               Diff_2_dos_adulto_mayor),
    Text_depart = match(DEPARTAMENTO, levels(DEPARTAMENTO)) - 0.45
  ) %>%
  ggplot(aes(x = ratio_vacuna, 
             y = DEPARTAMENTO)) +
  geom_line(aes(group = DEPARTAMENTO),
            color = "#b2b2b2",
            size = 1.5) +
  geom_point(aes(color = DOSIS), size = 5) +
  # scale_color_manual(
  #   values = c("#2CA58D", "#84BC9C", "#0A2342")
  # ) + 
  scale_color_manual(
    values = c("#ffa600", "#cf5187", "#2f4871")
  ) +
  # scale_color_manual(
  #   values = c("#31698c", "#2c8ba7", "#2f4871")
  # ) +
  # scale_color_brewer(palette="Set1") +
  scale_x_continuous(expand= c(0, 0),
                     limits = c(0, 0.3)) +
  scale_y_discrete(expand = c(0.05, 0)) +
  geom_text(aes(x = 0.052,
                y = 25.7,
                label = "Vacunados"),
            color = "black",
            size = 3.1,
            fontface = "bold") +
  geom_text(aes(x = 0.121,
                y = 25.7,
                label = "+60 años"),
            color = "black",
            size = 3.1,
            fontface = "bold") +
  ggrepel::geom_text_repel(aes(x = ratio_vacuna,
                               y = Text_depart,
                               label = scales::percent(ratio_vacuna,
                                                       accuracy = 1)),
                           size = 3, 
                           force = 0.01, force_pull = 8) + 
  geom_rect(aes(xmin = 0.2,
                xmax = 0.25,
                ymin = -Inf,
                ymax = Inf),
            fill = "grey") +
  geom_text(aes(x = 0.225,
                y = DEPARTAMENTO,
                label = scales::percent(Diff_1_dos_adulto_mayor,
                                        accuracy = 1)),
            fontface = "bold",
            size = 3) +
  geom_text(aes(x = 0.225,
                y = 25.7,
                label = "Diff"),
            color = "black",
            size = 3.1,
            fontface = "bold") +
  theme_bw() +
  labs(y = "",
       x = "") + 
  theme_bw(base_family="Lato") +
  theme(
    # panel.grid.major=element_blank(),
    panel.grid.minor=element_blank(),
    panel.border=element_blank(),
    axis.ticks=element_blank(),
    axis.text.x=element_blank(),
    plot.title=element_text(size = 16, face="bold"),
    plot.title.position = "plot",
    plot.subtitle=element_text(face="italic",
                               size=12, 
                               margin=margin(b=12)),
    plot.caption=element_text(size=8, 
                              margin=margin(t=12), 
                              color="#7a7d7e"),
    legend.position = "top"
  )
```

```{r}
ggsave(filename = "2. Plots/Diferencia en adultos mayores vacunados por departamento.png",
       plot = departamento_vac_adultos_mayores,
       height = 9,
       width = 6,
       dpi = 300)
```

La diferencia hacerlo mediante porcentaje del total de adultos mayores

Agregar una gráfico de barras en lugar del segment de diferencia 
